<!DOCTYPE html>
<html>
<head>
  <title>Runbooks @Stark &amp; Wayne</title>
  <link rel="stylesheet" type="text/css" href="style.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,intial-scale=1">
</head>
<body>
  <nav class="desktop">
    <span>Copyright &copy; 2018 <a target="_blank" href="https://starkandwayne.com">Stark &amp; Wayne</a></span>
    <span><a href="/">All Runbooks</a></span>
  </nav>
  <nav class="mobile">
    <span>&copy; <a target="_blank" href="https://starkandwayne.com">Stark &amp; Wayne</a></span>
    <span><a href="/">All</a></span>
  </nav>

  <header>
    <h1>Blacksmith Services</h1>
    <h2></h2>
  </header>

  <div id="m">
    <p>On-demand and shared services are provided by Blacksmith.
Blacksmith is a service broker for Cloud Foundry that uses a
dedicated BOSH director to deploy actual VMs in response to
service provisioning requests.  If a CF user wants a PostgreSQL
box all to themselves, Blacksmith will do so.</p>
<p>The <em>magic</em> of Blacksmith is accomplished by way of <em>Forges</em>,
small bits of configuration, packaged up as a BOSH release, that
can be added into a Blacksmith deployment.</p>
<p>The Blacksmith Genesis Kit packages three forges at the moment:</p>
<ol>
<li><a href="https://github.com/blacksmith-community/redis-forge-boshrelease">Redis</a></li>
<li><a href="https://github.com/blacksmith-community/rabbitmq-forge-boshrelease">RabbitMQ</a></li>
<li><a href="https://github.com/blacksmith-community/postgresql-forge-boshrelease">PostgreSQL</a></li>
</ol>
<p>Refer to their specific project pages for more details information
on their features and configuration.</p>
<p>The <a href="https://github.com/genesis-community/blacksmith-genesis-kit">Blacksmith Kit documentation</a> explains how to
configure each of these Forges and their service offerings.</p>
<h2>Determine the IP address of your Blacksmith Broker</h2>
<p>You can get this from BOSH itself:</p>
<pre><code>$ bosh -d your-blacksmith vms
Using environment 'https://10.0.0.4' as client 'admin'

Task 5923. Done

Deployment 'your-blacksmith'

Instance                                         Process State  AZ  IPs       VM CID                                   VM Type
blacksmith/5600d462-f8c8-4a85-ae7b-2028ae4ffafe  running        z1  10.5.6.7  vm-0e68f44e-a768-418a-9c97-3c1d489ae000  blacksmith

1 vms

Succeeded
</code></pre>
<p>Blacksmith runs on port <code>3000</code> by default, so the URL of this
particular Blacksmith is <code>http://10.5.6.7:3000</code>.</p>
<h2>Register a Blacksmith Broker</h2>
<p>Before your Cloud Foundry users can start provisioning services
via your new Blacksmith, it has to be registered with Cloud
Foundry, and enabled in the CF marketplace.</p>
<p>To register the broker, you’ll need its IP address (see
<em>Determining the IP address of your Blacksmith Broker</em>).</p>
<pre><code>$ cf create-service-broker \
     your-env-name-blacksmith \
     blacksmith \
     $(safe read secret/your/env/name/blacksmith/broker:password)
     http://$IP:3000
</code></pre>
<p>The first argument is the name of your broker.  If you have
multiple Blacksmith brokers, you will want to choose appropriate
names to distinguish them.</p>
<p>The second argument is the HTTP username for accessing the broker
API.  This is always <code>blacksmith</code>.</p>
<p>The third argument is the password for the HTTP <code>blacksmith</code> user.
This is stored in the Vault, and the <code>$(safe ...)</code> call in the
listing will extract it for you.</p>
<p>The final argument is the URL of the broker API, which depends on
the IP of the broker.  The port is always 3000.</p>
<p>You can verify that the broker is registered, by checking that it
is listed in the output of <code>cf service-brokers</code></p>
<p>For more details, refer to <a href="https://docs.cloudfoundry.org/services/managing-service-brokers.html">Managing Service Brokers</a>, in
the official Cloud Foundry documentation.</p>
<p>Next, you’ll need to enable access to the Blacksmith broker’s
services and plans, so that Cloud Foundry users will see them in
the marketplace:</p>
<pre><code>$ cf enable-service-access your-env-name-blacksmith
</code></pre>
<p>This makes all the plans and services owned by the
<code>your-env-name-blacksmith</code> broker available to all orgs and spaces
in your Cloud Foundry instance.  If you need stricter permissions,
check the <a href="https://docs.cloudfoundry.org/services/access-control.html#enable-access">Marketplace Access Control</a> section of the
official Cloud Foundry documentation.</p>
<p>You can verify the publication of your Blacksmith broker’s plans
by running <code>cf marketplace</code> and checking that you see the plans
you defined in your Blacksmith manifests.</p>
<h2>Access the Blacksmith Management UI</h2>
<p>The Blacksmith Management Web UI provides an overview of what is
going on with a single Blacksmith Services Broker.</p>
<p>To access it, you’ll need to know the service broker VM IP
address, which you can get from BOSH itself:</p>
<pre><code>$ bosh -d your-blacksmith vms
Using environment 'https://10.0.0.4' as client 'admin'

Task 5923. Done

Deployment 'your-blacksmith'

Instance                                         Process State  AZ  IPs       VM CID                                   VM Type
blacksmith/5600d462-f8c8-4a85-ae7b-2028ae4ffafe  running        z1  10.5.6.7  vm-0e68f44e-a768-418a-9c97-3c1d489ae000  blacksmith

1 vms

Succeeded
</code></pre>
<p>Blacksmith runs on port <code>3000</code> by default, so you can open a
browser to <code>http://10.5.6.7:3000</code>.</p>
<p>All of Blacksmith is protected by HTTP basic authentication.  The
username is always <code>blacksmith</code>, and the password can be found in
your Vault:</p>
<pre><code>$ safe read secret/$ENV/blacksmith/broker:password
</code></pre>
<p>(replacing <code>$ENV</code> with your actually environment prefix, something
like <code>us/east/2/prod</code> for <code>us-east-2-prod</code>).</p>
<p>The UI lists the current catalog:</p>
<p><img src="images/services/catalog.png" alt="Catalog Listing"></p>
<p>It also lists all deployed instances:</p>
<p><img src="images/services/services.png" alt="Services Listing"></p>
<p>Finally, the last 8,000 (or so) log lines are buffered and printed
to the <em>Log</em> section:</p>
<p><img src="images/services/logs.png" alt="Blacksmith Logs"></p>
<h2>Install <code>eden</code></h2>
<p><a href="https://github.com/starkandwayne/eden">eden</a> is a command-line utility for interacting with Open
Service Broker API implementations.  All Cloud Foundry service
brokers conform to OSB, so <code>eden</code> works with Blacksmith.</p>
<p>On Mac OS, if you use <a href="https://brew.sh">Homebrew</a>, you can <code>brew install eden</code> and you’re done.</p>
<p>On Ubuntu Linux, you can add the <a href="http://apt.starkandwayne.com">Stark &amp; Wayne APT
repository</a> and just <code>apt install eden</code>.</p>
<p>On all other platforms, you can check out the <a href="https://github.com/starkandwayne/eden/releases">Eden Github
Releases page</a> to see if there is a pre-built
binary for you.</p>
<h2>Configure <code>eden</code> To Work With Your Blacksmith</h2>
<p>The <code>eden</code> utility needs to know the URL of the Blacksmith broker,
as well as the username and password for accessing it.  These
should be set in the <code>SB_BROKER_*</code> environment variables:</p>
<pre><code>$ export SB_BROKER_URL=http://$IP:3000
$ export SB_BROKER_USERNAME=blacksmith
$ export SB_BROKER_PASSWORD=$(safe read secret/your/env/name/blacksmith/broker:password)
</code></pre>
<p>You can verify that your local environment is properly configured
by querying the Blacksmith service catalog:</p>
<pre><code>$ eden catalog
</code></pre>
<p>Note: this will be a subset of your actual CF marketplace.
Otherwise, details should match.</p>
<h2>Provision a Service via <code>cf</code></h2>
<p>Cloud Foundry users can create new services using the standard
process, with the <code>cf</code> command-line utility:</p>
<pre><code>$ cf create-service dedicated-redis standalone my-kvstore
</code></pre>
<p>This will create a dedicated Redis instance, as a standalone,
single-VM deployment.  The name of the service (which is
arbitrary) will be <code>my-kvstore</code>.</p>
<p>Blacksmith is an asynchronous service broker, so the
<code>create-service</code> operation will return immediately, but the
service will be marked as <em>in progress</em>, until the Blacksmith BOSH
director has finished deploying it.  You can check on the progress
by issuing:</p>
<pre><code>$ cf service my-kvstore
</code></pre>
<p>Once the service is created, it can be bound to an application:</p>
<pre><code>$ cf bind-service key-value-app my-kvstore
</code></pre>
<p>The first argument is the application name (from a <code>cf push</code>), and
the second argument is the name we gave the service in our <code>cf create-service</code> call.</p>
<p>For more in-depth review of Cloud Foundry services and
applications, check the <a href="https://docs.cloudfoundry.org/devguide/services/">Service Overview</a> in the official
Cloud Foundry documentation.</p>
<h2>Remove a Service via <code>cf</code></h2>
<p>To remove a service, Cloud Foundry users should use the standard
<code>cf</code> command-line utility.</p>
<p>First, get a list of services provisioned in the current space:</p>
<pre><code>$ cf services
</code></pre>
<p>If the service you want is bound to any applications, it will need
to be unbound before it can be deleted:</p>
<pre><code>$ cf unbind-service app-name service-name
</code></pre>
<p>Then, it can be deleted:</p>
<pre><code>$ cf delete-service service-name
</code></pre>
<p>Blacksmith is an asynchronous service broker, so the
<code>delete-service</code> operation will return immediately, but the
service will be marked as <em>in progress</em>, until the Blacksmith BOSH
director has finished deploying it.  You can check on the progress
by issuing:</p>
<pre><code>$ cf service service-name
</code></pre>
<p>but be aware that once the operation succeeds, the service
information will be purged from the Cloud Foundry database, so <code>cf service</code> will start failing because the service is unknown.</p>
<p>For more in-depth review of Cloud Foundry services and
applications, check the <a href="https://docs.cloudfoundry.org/devguide/services/">Service Overview</a> in the official
Cloud Foundry documentation.</p>
<h2>Provision a Service via <code>eden</code> (as an Operator)</h2>
<p>NOTE: This task requires that <code>eden</code> is installed, and properly
configured to work with your Blacksmith.</p>
<p>As an operator, you have the ability to bypass Cloud Foundry and
create service directly in Blacksmith.  This is a powerful
debugging and diagnostic tool, especially if you suspect that
Cloud Foundry is somehow responsible for some strange behavior.</p>
<p><strong>However</strong>, use this technique sparingly.  Services provisioned
via <code>eden</code>, directly against the Blacksmith broker, will not show
up in <code>cf services</code>, and only the Blacksmith Management UI itself
will show you the instance IDs if you lose track of them.  Service
provisioned out-of-band will also use up quota allocations.</p>
<p>To provision a service, use <code>eden provision</code></p>
<pre><code>$ eden provision -s dedicated-redis -p standalone
</code></pre>
<p>Unlike the <code>cf</code> command-line utility, <code>eden</code> will regularly poll
the broker until the create operation either succeeds or fails.
In the event of failure, you should check the the Blacksmith
Management Web UI log (or the logs on the broker VM itself) for
details.</p>
<p>Once the operation succeeds, <code>eden</code> will tell you how to bind the
service to get at the credentials.  It will be something like:</p>
<pre><code>$ eden bind -i &lt;big-long-identifier-string&gt;
</code></pre>
<h2>Remove a Service via <code>eden</code></h2>
<p>NOTE: This task requires that <code>eden</code> is installed, and properly
configured to work with your Blacksmith.</p>
<p>It is important to keep in mind that each operator has their own
local <code>eden</code> configuration.  This is where <code>eden</code> stores
information about services it has provisioned.  That means that if
someone on your team has used <code>eden</code> to provision a service, you
won’t see that instance when you run <code>eden services</code> - you will
only see the services <em>you</em> have provisioned.</p>
<p>It is also important to remember that <code>eden</code> has no way of knowing
what services <em>Cloud Foundry itself</em> has provisioned.</p>
<p>Luckily, most of that doesn’t matter, since <code>eden</code> does let you
deprovision a service by its instance ID.  You can get the
instance ID of a service from <code>cf service --guid my-service</code>, or
from the Blacksmith Management Web UI.</p>
<p>To delete a service directly:</p>
<pre><code>$ eden deprovision -i &lt;big-long-identifier-string&gt;
</code></pre>
<p><code>eden</code> will poll Blacksmith until the delete operation succeeds or
fails.  In the event of failure, you should check the the
Blacksmith Management Web UI log (or the logs on the broker VM
itself) for details.</p>
<h2>Clean Up Blacksmith via <code>eden</code></h2>
<p>NOTE: This task requires that <code>eden</code> is installed, and properly
configured to work with your Blacksmith.</p>
<p>Blacksmith currently fails to understand the responses from newer
BOSH directors (264.5+) to the <em>delete deployment</em> API call, which
cause it to mistakenly believe that the deletion failed.</p>
<p>Until that bug gets fixed and a new Kit released, you can use
<code>eden</code> to <em>double-delete</em> a service instance.  When Blacksmith
goes to delete the (deleted) service deployment, it will notice
that the deployment is gone, and go through its normal cleanup
routines.</p>
<pre><code>$ eden deprovision -i &lt;big-long-identifier-string&gt;
</code></pre>
<h2>Troubleshoot Service Failures</h2>
<p>If a service fails to deploy, Cloud Foundry users will not get
much detail from Cloud Foundry itself.  This is a self-protective
measure taken by the Blacksmith system itself, to avoid leaking
sensitive implementation details.</p>
<p>As an operator, you have access to the deployment log for the
service, if you know the internal UUID/GUID that Cloud Foundry has
assigned to the service instance.</p>
<p>This can be found by running:</p>
<pre><code>$ cf service --guid service-name
</code></pre>
<p>From the Blacksmith Management Web UI, go to the <em>Services</em>
section and look for the entry in the table that corresponds to
the service GUID.  The deployment log can be reached by the
<code>task.log</code> link.</p>
<p><img src="images/services/services.png" alt="Services Section"></p>
<p>The task log is what you would have seen had you deployed this
service yourself, manually, via <code>bosh deploy</code> or <code>genesis deploy</code>:</p>
<pre><code>Task 15 | 20:54:31 | Preparing deployment: Preparing deployment started
Task 15 | 20:54:31 | Preparing deployment: Preparing deployment failed
Task 15 | 20:54:31 | ERROR: [50003] Stemcell with Operating System 'ubuntu-trusty' doesn't exist
</code></pre>
<p>In this case, the stemcell hasn’t been uploaded.  Oops.</p>
<h2>Retrieve Service Credentials as an Operator</h2>
<p>From the Blacksmith Management Web UI, you can access the full and
unredacted deployment manifest by clicking on the <code>manifest.yml</code>
link in the <em>Services</em> section.</p>
<p><img src="images/services/services.png" alt="Services Section"></p>
<p>The credentials are stored in the manifest:</p>
<pre><code>director_uuid: f03bca94-cef8-4257-b2f2-df1b527633c1
instance_groups:
- azs:
  - z1
  instances: 1
  jobs:
  - name: standalone
    properties:
      auth:
        password:
byett87B5RfQvcjvaX1VDEy7ZLwBU31Tz1c0zjUKQVjkHUWrLJyubjV24usa962j
    release: redis-forge
  name: standalone
  networks:
  - name: redis-service
  persistent_disk_type: default
  stemcell: default
  vm_type: sm-2cpu-4g
meta:
  params: {}
  password:
byett87B5RfQvcjvaX1VDEy7ZLwBU31Tz1c0zjUKQVjkHUWrLJyubjV24usa962j
  size: sm-2cpu-4g
name: redis-dedicated-cache-493db828-c58a-4253-aa5b-fb12aa5004ba
releases:
- name: redis-forge
  version: latest
stemcells:
- alias: default
  os: ubuntu-trusty
  version: latest
update:
  canaries: 1
  canary_watch_time: 1000-30000
  max_in_flight: 10
  update_watch_time: 1000-30000
</code></pre>
<p>This manifest has been mangled by machines, so it’s not the most
legible thing in the world.</p>
<h2>Retrieve Service Credentials as an End User</h2>
<p>Cloud Foundry users should use <code>cf service my-service</code> and
inspect the contents of the <code>VCAP_SERVICES</code> environment variable
JSON to determine their service credentials.</p>
<h2>Target the Blacksmith BOSH Director</h2>
<p>Blacksmith deploys all of its service deployments by way of an
internal BOSH director, separate from all of your other BOSH
directors.  This internal director lives on the Blacksmith broker
VM itself.</p>
<p>For more advanced troubleshooting, you may need to SSH into a VM
on a service deployment.  To do that, you first need to target
that director.</p>
<p>First, set up a BOSH alias for the Blacksmith BOSH director:</p>
<pre><code>$ bosh -e https://$IP:25555 \
       --ca-cert &lt;(safe read secret/your/env/name/blacksmith/tls/ca:certificate) \
       alias-env your-env-blacksmith
</code></pre>
<p>Then, login with the <code>admin</code> credentials:</p>
<pre><code>$ safe read secret/your/env/name/blacksmith/users/admin:password
secret-password-here

$ bosh -e your-env-blacksmith login
</code></pre>
<p>From there, you can run all the normal BOSH commands against the
director.  You can SSH into deployments, check VM health, etc.</p>
<p>All of your tasks will be attributed to the <code>admin</code> user.
Blacksmith itself uses the <code>blacksmith</code> user so as not to confuse
things.</p>

  </div>

  <footer>
    Copyright &copy; 2018 <a target="_blank" href="https://starkandwayne.com">Stark &amp; Wayne</a>
  </footer>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="runbook.js"></script>
</body>
</html>
